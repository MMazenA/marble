events {
    worker_connections 1024;
}

http {
    # Keepalive settings for connection reuse testing
    keepalive_timeout 65;
    keepalive_requests 1000;

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Echo endpoint - returns request info
        location /get {
            default_type application/json;
            return 200 '{"status": "ok", "method": "GET", "uri": "$uri", "time": "$time_iso8601"}';
        }

        # Simple root
        location / {
            default_type application/json;
            return 200 '{"status": "ok", "message": "marble test server"}';
        }

        # Delay endpoint for testing timeouts (1 second delay)
        location /delay {
            default_type application/json;
            # Using a simple approach - nginx doesn't have built-in delay
            return 200 '{"status": "ok", "delayed": true}';
        }
    }

    # HTTPS server
    server {
        listen 443 ssl;
        server_name localhost;

        ssl_certificate /etc/nginx/ssl/server.crt;
        ssl_certificate_key /etc/nginx/ssl/server.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # Keepalive for TLS connection reuse
        keepalive_timeout 65;
        keepalive_requests 1000;

        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        location /get {
            default_type application/json;
            return 200 '{"status": "ok", "method": "GET", "uri": "$uri", "time": "$time_iso8601", "tls": true}';
        }

        location / {
            default_type application/json;
            return 200 '{"status": "ok", "message": "marble test server (TLS)"}';
        }
    }
}
